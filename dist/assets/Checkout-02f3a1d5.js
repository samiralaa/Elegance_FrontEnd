import{_ as U,o as u,c as h,a as i,t as d,n as b,A as v,b as _,r as $,F as E,d as L,w as C,v as q,e as O,f as w,g as H,h as Q,i as K,H as X,j as Y,k as V}from"./index-734559de.js";const ee={name:"CheckoutStepper",props:{step:{type:Number,required:!0}}},te={class:"stepper"},re={class:"step-label"},se={class:"step-label"},ae={class:"step-label"};function ie(e,t,s,o,r,n){return u(),h("div",te,[i("div",{class:b(["step",{active:s.step>=1,completed:s.step>1}])},[t[0]||(t[0]=i("div",{class:"step-number"},"1",-1)),i("div",re,d(e.$t("checkout.cart")),1)],2),i("div",{class:b(["step-line",{active:s.step>1}])},null,2),i("div",{class:b(["step",{active:s.step>=2,completed:s.step>2}])},[t[1]||(t[1]=i("div",{class:"step-number"},"2",-1)),i("div",se,d(e.$t("checkout.shipping")),1)],2),i("div",{class:b(["step-line",{active:s.step>2}])},null,2),i("div",{class:b(["step",{active:s.step>=3}])},[t[2]||(t[2]=i("div",{class:"step-number"},"3",-1)),i("div",ae,d(e.$t("checkout.payment")),1)],2)])}const ne=U(ee,[["render",ie],["__scopeId","data-v-4a5013a8"]]);const oe={name:"CartReview",props:{cartItems:{type:Array,required:!0},shippingCost:{type:Number,required:!0},currency:{type:String,required:!0}},computed:{currentLang(){return localStorage.getItem("lang")||"en"},subtotal(){return this.cartItems.reduce((e,t)=>!t.product||!t.product.converted_price?e:e+parseFloat(t.product.converted_price)*t.quantity,0).toFixed(2)},total(){return(parseFloat(this.subtotal)+this.shippingCost).toFixed(2)}},methods:{getProductImage(e){return e.images&&Array.isArray(e.images)?`${v}/public/storage/${e.images[0]}`:`${v}/images/default.jpg`},async updateCartItemQuantity(e){var t,s,o;e.quantity<1&&(e.quantity=1),e.quantity>99&&(e.quantity=99);try{const r=await _.post(`${v}/api/cart-items/${e.id}`,{quantity:e.quantity},{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,"Content-Type":"application/json"}});if(r.data){alert("etst");const a=r.data.data;e.quantity=(a==null?void 0:a.quantity)??e.quantity,e.price=(a==null?void 0:a.price)??e.price;const l=this.$t("checkout.quantityUpdated")||"Quantity updated successfully";this.$toast.success(l)}else{const a=((t=r==null?void 0:r.data)==null?void 0:t.message)||this.$t("checkout.errorUpdatingQuantity");this.$toast.error(a)}this.$emit("update-cart")}catch(r){console.error("Error updating quantity:",r);let n="Error updating quantity";(o=(s=r==null?void 0:r.response)==null?void 0:s.data)!=null&&o.message?n=r.response.data.message:this.$t&&this.$t("checkout.errorUpdatingQuantity")&&(n=this.$t("checkout.errorUpdatingQuantity")),this.$toast.error(n)}},async updateCartItemQuantity(e){var t,s,o;e.quantity<1&&(e.quantity=1),e.quantity>99&&(e.quantity=99);try{const r=await _.post(`${v}/api/cart-items/${e.id}`,{quantity:e.quantity},{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,"Content-Type":"application/json"}}),n=(t=r==null?void 0:r.data)==null?void 0:t.data;if(n){e.quantity=n.quantity,e.price=n.price,e.converted_price=n.converted_price,e.converted_total=n.converted_total,e.currency_code=n.currency_code,n.product&&(e.product=n.product);const a=this.$t("checkout.quantityUpdated")||"Quantity updated successfully";this.$toast.success(a),this.$emit("update-cart",[...this.cartItems])}else{const a=this.$t("checkout.errorUpdatingQuantity")||"Error updating quantity";this.$toast.error(a)}}catch(r){console.error("Error updating quantity:",r);const n=((o=(s=r==null?void 0:r.response)==null?void 0:s.data)==null?void 0:o.message)||this.$t("checkout.errorUpdatingQuantity")||"Error updating quantity";this.$toast.error(n)}},async increaseQuantity(e){e.quantity<99?(e.quantity++,await this.updateCartItemQuantity(e)):this.$toast.warning(this.$t("checkout.maxQuantity"))},async decreaseQuantity(e){e.quantity>1?(e.quantity--,await this.updateCartItemQuantity(e)):this.$toast.warning(this.$t("checkout.minimumQuantity"))},async removeItem(e){try{await _.delete(`${v}/api/cart-items/${e}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}}),this.$emit("update-cart",this.cartItems.filter(t=>t.id!==e)),this.$toast.success(this.$t("checkout.itemRemoved"))}catch(t){console.error("Error removing item:",t),this.$toast.error("this.$t('checkout.errorRemovingItem')")}},calculateDiscountedPrice(e){const t=e.product;if(!t)return"";if(t.discount&&t.discount.length>0){const s=parseFloat(t.discount[0].discount_value),o=parseFloat(t.converted_price);return(o-o*(s/100)).toFixed(2)}return t.converted_price}}},ce={class:"checkout-step"},de={class:"cart-items"},le=["src","alt"],ue={class:"item-details"},pe={class:"item-price"},he={class:"quantity-controls"},me=["onClick","disabled"],ye=["onUpdate:modelValue","onChange","onInput"],ge=["onClick","disabled"],_e=["onClick"],fe={class:"cart-summary"},ve={class:"summary-row"},be={class:"summary-row total"},Se=["disabled"];function ke(e,t,s,o,r,n){const a=$("fa");return u(),h("div",ce,[i("h2",null,d(e.$t("checkout.reviewCart")),1),i("div",de,[(u(!0),h(E,null,L(s.cartItems,l=>{var f,S,k;return u(),h("div",{key:l.id,class:"cart-item"},[i("img",{src:n.getProductImage(l),alt:((f=l.product)==null?void 0:f.name_en)||"",class:"item-image"},null,8,le),i("div",ue,[i("h3",null,d(n.currentLang==="ar"?(S=l.product)==null?void 0:S.name_ar:(k=l.product)==null?void 0:k.name_en),1),i("p",pe,d(n.calculateDiscountedPrice(l))+" "+d(s.currency),1),i("div",he,[i("button",{onClick:g=>n.decreaseQuantity(l),disabled:l.quantity<=1},"-",8,me),C(i("input",{dir:"ltr",class:"form-control qty-number",type:"number",min:"1",max:"99","onUpdate:modelValue":g=>l.quantity=g,onChange:g=>n.updateCartItemQuantity(l),onInput:g=>l.quantity=Math.min(Math.max(l.quantity,1),99),onKeydown:t[0]||(t[0]=g=>["e","E",".","+","-"].includes(g.key)&&g.preventDefault())},null,40,ye),[[q,l.quantity,void 0,{number:!0}]]),i("button",{onClick:g=>n.increaseQuantity(l),disabled:l.quantity>=99},"+",8,ge)])]),i("button",{class:"remove-item",onClick:g=>n.removeItem(l.id)},[O(a,{icon:"trash"})],8,_e)])}),128))]),i("div",fe,[i("div",ve,[i("span",null,d(e.$t("checkout.subtotal")),1),i("span",null,d(n.subtotal)+" "+d(s.currency),1)]),i("div",be,[i("span",null,d(e.$t("checkout.total")),1),i("span",null,d(n.total)+" "+d(s.currency),1)])]),i("button",{class:"btn-primary",onClick:t[1]||(t[1]=l=>e.$emit("next-step")),disabled:!s.cartItems.length},d(e.$t("checkout.continueToShipping")),9,Se)])}const Ie=U(oe,[["render",ke],["__scopeId","data-v-d230650e"]]);const Ce={name:"ShippingDetails",props:{modelValue:{type:Object,required:!0},currency:{type:String,required:!1}},data(){return{savedAddresses:[],selectedAddressId:null,loading:!1,error:null,selectedAddress:null,isNewAddress:!1,countries:[],countryLoading:!1,cities:[]}},computed:{shippingDetails:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}},isValid(){return this.isNewAddress?this.shippingDetails.buildingName&&this.shippingDetails.floorNumber&&this.shippingDetails.apartmentNumber&&this.shippingDetails.landmark&&this.shippingDetails.postalCode&&this.shippingDetails.cityId&&this.shippingDetails.countryId:this.selectedAddressId!==null}},methods:{async fetchSavedAddresses(){var e,t;this.loading=!0;try{const s=await _.get("https://backend.webenia.org/api/address",{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,"Content-Type":"application/json"}});if(s.data.status&&s.data.data){this.savedAddresses=s.data.data;const o=this.savedAddresses.find(r=>r.is_primary);o&&this.selectAddress(o)}}catch(s){console.error("Error fetching addresses:",s),this.error=((t=(e=s.response)==null?void 0:e.data)==null?void 0:t.message)||s.message}finally{this.loading=!1}},selectAddress(e){var t;this.selectedAddressId=e.id,this.selectedAddress=e,this.isNewAddress=!1,this.shippingDetails={...this.shippingDetails,addressId:e.id,country_id:e.country_id,city_id:e.city_id,city:((t=e.city)==null?void 0:t.name_en)||e.city_name,buildingName:e.building_name,floorNumber:e.floor_number,apartmentNumber:e.apartment_number,landmark:e.landmark,postalCode:e.postal_code,address:`${e.building_name}, ${e.landmark}, Floor ${e.floor_number}, Apartment ${e.apartment_number}`}},async saveNewAddress(){var e,t;try{const s=localStorage.getItem("auth_token");let o=1;if(s)try{o=JSON.parse(atob(s.split(".")[1])).sub||1}catch(a){console.error("Error decoding token:",a)}const r={user_id:o,city_id:this.shippingDetails.cityId||1,country_id:this.shippingDetails.countryId||1,building_name:this.shippingDetails.buildingName,floor_number:this.shippingDetails.floorNumber,apartment_number:this.shippingDetails.apartmentNumber,landmark:this.shippingDetails.landmark,postal_code:this.shippingDetails.postalCode,is_primary:this.savedAddresses.length===0},n=await _.post("https://backend.webenia.org/api/address",r,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,"Content-Type":"application/json"}});if(n.data.status){const a=n.data.data;return this.savedAddresses.push(a),this.selectAddress(a),a.id}throw new Error(n.data.message||"Failed to save address")}catch(s){throw console.error("Error saving address:",s),this.error=((t=(e=s.response)==null?void 0:e.data)==null?void 0:t.message)||s.message,s}},async handleSubmit(){if(this.isValid)try{let e=this.selectedAddressId;this.isNewAddress&&(e=await this.saveNewAddress());const t={...this.shippingDetails,addressId:e};this.$emit("next-step",t)}catch(e){const t=e.message||this.$t("checkout.errorSavingAddress");this.$toast.error(t)}},toggle(){this.isOpen=!this.isOpen},selectOption(e){this.selectedValue=e.value,this.$emit("update:modelValue",e.value),this.isOpen=!1},async fetchCountries(){var e;this.countryLoading=!0;try{const t=await _.get("https://backend.webenia.org/api/countries");this.countries=((e=t.data)==null?void 0:e.data)||[]}catch(t){console.error("Error fetching countries:",t)}finally{this.countryLoading=!1}},async fetchCities(){if(!this.shippingDetails.countryId){this.cities=[];return}try{const e=await _.get(`https://backend.webenia.org/api/countries/${this.shippingDetails.countryId}`);this.cities=e.data.data.original.data.cities}catch(e){console.error("Failed to fetch cities:",e),this.cities=[]}}},watch:{"shippingDetails.countryId"(e,t){e!==t&&(this.shippingDetails.cityId=null,this.fetchCities())}},mounted(){this.fetchSavedAddresses(),this.fetchCountries(),this.shippingDetails.countryId&&this.fetchCities()}},we={class:"checkout-step"},$e={class:"address-type-selector"},Ae={key:0,class:"saved-addresses"},De={class:"address-list"},qe=["onClick"],Ee={class:"address-info"},Pe={key:0,class:"primary-badge"},Ne={class:"address-actions"},Me={class:"form-group"},Te={for:"country"},Fe={key:0,disabled:""},Le=["value"],Ue={class:"form-group"},Be={for:"city"},Ge=["value"],Oe={class:"form-group"},Ve={for:"buildingName"},Re={class:"form-group"},Qe={for:"floorNumber"},je={class:"form-group"},xe={for:"apartmentNumber"},ze={class:"form-group"},We={for:"landmark"},Ze={class:"form-group"},Je={for:"postalCode"},He={class:"button-group"},Ke=["disabled"];function Xe(e,t,s,o,r,n){return u(),h("div",we,[i("h2",null,d(e.$t("checkout.shippingDetails")),1),i("div",$e,[i("button",{class:b(["type-btn",{active:!r.isNewAddress}]),onClick:t[0]||(t[0]=a=>r.isNewAddress=!1)},d(e.$t("checkout.selectExistingAddress")),3),i("button",{class:b(["type-btn",{active:r.isNewAddress}]),onClick:t[1]||(t[1]=a=>r.isNewAddress=!0)},d(e.$t("checkout.createNewAddress")),3)]),!r.isNewAddress&&r.savedAddresses.length?(u(),h("div",Ae,[i("h3",null,d(e.$t("checkout.savedAddresses")),1),i("div",De,[(u(!0),h(E,null,L(r.savedAddresses,a=>(u(),h("div",{key:a.id,class:b(["address-card",{selected:r.selectedAddressId===a.id}]),onClick:l=>n.selectAddress(a)},[i("div",Ee,[i("p",null,[i("strong",null,d(a.building_name),1)]),i("p",null,d(a.landmark),1),i("p",null,"Floor "+d(a.floor_number)+", Apartment "+d(a.apartment_number),1),i("p",null,"Postal Code: "+d(a.postal_code),1),a.is_primary?(u(),h("p",Pe,d(e.$t("checkout.primaryAddress")),1)):w("",!0)]),i("div",Ne,[i("button",{class:b(["btn-select",{selected:r.selectedAddressId===a.id}])},d(r.selectedAddressId===a.id?e.$t("checkout.selected"):e.$t("checkout.select")),3)])],10,qe))),128))])])):w("",!0),r.isNewAddress?(u(),h("form",{key:1,onSubmit:t[9]||(t[9]=H((...a)=>n.handleSubmit&&n.handleSubmit(...a),["prevent"])),class:"shipping-form"},[i("div",Me,[i("label",Te,d(e.$t("checkout.country")),1),C(i("select",{id:"country","onUpdate:modelValue":t[2]||(t[2]=a=>n.shippingDetails.countryId=a),required:""},[r.countryLoading?(u(),h("option",Fe,"Loading...")):w("",!0),(u(!0),h(E,null,L(r.countries,a=>(u(),h("option",{key:a.id,value:a.id},d(a.name_en||a.name_ar),9,Le))),128))],512),[[Q,n.shippingDetails.countryId]])]),i("div",Ue,[i("label",Be,d(e.$t("checkout.city")),1),C(i("select",{id:"city",class:"form-select","onUpdate:modelValue":t[3]||(t[3]=a=>n.shippingDetails.cityId=a),required:""},[(u(!0),h(E,null,L(r.cities,a=>(u(),h("option",{key:a.id,value:a.id},d(e.$i18n.locale==="ar"?a.name_ar:a.name_en),9,Ge))),128))],512),[[Q,n.shippingDetails.cityId]])]),i("div",Oe,[i("label",Ve,d(e.$t("checkout.buildingName")),1),C(i("input",{type:"text",id:"buildingName","onUpdate:modelValue":t[4]||(t[4]=a=>n.shippingDetails.buildingName=a),required:""},null,512),[[q,n.shippingDetails.buildingName]])]),i("div",Re,[i("label",Qe,d(e.$t("checkout.floorNumber")),1),C(i("input",{type:"text",id:"floorNumber","onUpdate:modelValue":t[5]||(t[5]=a=>n.shippingDetails.floorNumber=a),required:""},null,512),[[q,n.shippingDetails.floorNumber]])]),i("div",je,[i("label",xe,d(e.$t("checkout.apartmentNumber")),1),C(i("input",{type:"text",id:"apartmentNumber","onUpdate:modelValue":t[6]||(t[6]=a=>n.shippingDetails.apartmentNumber=a),required:""},null,512),[[q,n.shippingDetails.apartmentNumber]])]),i("div",ze,[i("label",We,d(e.$t("checkout.landmark")),1),C(i("input",{type:"text",id:"landmark","onUpdate:modelValue":t[7]||(t[7]=a=>n.shippingDetails.landmark=a),required:""},null,512),[[q,n.shippingDetails.landmark]])]),i("div",Ze,[i("label",Je,d(e.$t("checkout.postalCode")),1),C(i("input",{type:"text",id:"postalCode","onUpdate:modelValue":t[8]||(t[8]=a=>n.shippingDetails.postalCode=a),required:""},null,512),[[q,n.shippingDetails.postalCode]])])],32)):w("",!0),i("div",He,[i("button",{type:"button",class:"btn-secondary",onClick:t[10]||(t[10]=a=>e.$emit("previous-step"))},d(e.$t("checkout.back")),1),i("button",{type:"button",class:"btn-primary",onClick:t[11]||(t[11]=(...a)=>n.handleSubmit&&n.handleSubmit(...a)),disabled:!n.isValid},d(e.$t("checkout.continueToPayment")),9,Ke)])])}const Ye=U(Ce,[["render",Xe],["__scopeId","data-v-b0529828"]]);var z="basil",et=function(t){return t===3?"v3":t},W="https://js.stripe.com",tt="".concat(W,"/").concat(z,"/stripe.js"),rt=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,st=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,j="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",at=function(t){return rt.test(t)||st.test(t)},it=function(){for(var t=document.querySelectorAll('script[src^="'.concat(W,'"]')),s=0;s<t.length;s++){var o=t[s];if(at(o.src))return o}return null},x=function(t){var s=t&&!t.advancedFraudSignals?"?advancedFraudSignals=false":"",o=document.createElement("script");o.src="".concat(tt).concat(s);var r=document.head||document.body;if(!r)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return r.appendChild(o),o},nt=function(t,s){!t||!t._registerWrapper||t._registerWrapper({name:"stripe-js",version:"7.3.1",startTime:s})},T=null,B=null,G=null,ot=function(t){return function(s){t(new Error("Failed to load Stripe.js",{cause:s}))}},ct=function(t,s){return function(){window.Stripe?t(window.Stripe):s(new Error("Stripe.js not available"))}},dt=function(t){return T!==null?T:(T=new Promise(function(s,o){if(typeof window>"u"||typeof document>"u"){s(null);return}if(window.Stripe&&t&&console.warn(j),window.Stripe){s(window.Stripe);return}try{var r=it();if(r&&t)console.warn(j);else if(!r)r=x(t);else if(r&&G!==null&&B!==null){var n;r.removeEventListener("load",G),r.removeEventListener("error",B),(n=r.parentNode)===null||n===void 0||n.removeChild(r),r=x(t)}G=ct(s,o),B=ot(o),r.addEventListener("load",G),r.addEventListener("error",B)}catch(a){o(a);return}}),T.catch(function(s){return T=null,Promise.reject(s)}))},lt=function(t,s,o){if(t===null)return null;var r=s[0],n=r.match(/^pk_test/),a=et(t.version),l=z;n&&a!==l&&console.warn("Stripe.js@".concat(a," was loaded on the page, but @stripe/stripe-js@").concat("7.3.1"," expected Stripe.js@").concat(l,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var f=t.apply(void 0,s);return nt(f,o),f},F,Z=!1,J=function(){return F||(F=dt(null).catch(function(t){return F=null,Promise.reject(t)}),F)};Promise.resolve().then(function(){return J()}).catch(function(e){Z||console.warn(e)});var ut=function(){for(var t=arguments.length,s=new Array(t),o=0;o<t;o++)s[o]=arguments[o];Z=!0;var r=Date.now();return J().then(function(n){return lt(n,s,r)})};function pt(e,t){return t==="USD"?e/3.67:e}const ht={name:"PaymentStep",props:{cartItems:{type:Array,required:!0},shippingDetails:{type:Object,required:!0},total:{type:Number,required:!0},currency:{type:String,required:!0}},data(){return{selectedPaymentMethod:null,paymentMethods:[{id:1,name:"Stripe",icon:"assets/strappi.png",class:"",style:"border-radius: 50%;"},{id:2,name:"Tabby",icon:"assets/tabby.png",class:"tappy-disabled",style:"border-radius: 50%;"},{id:3,name:"Cash on Delivery",icon:"assets/cash.png",class:"",style:""}],loading:!1,stripePromise:null,stripeClientSecret:null,stripeElements:null,cardElement:null,apiCartTotal:0}},created(){this.stripePromise=ut("pk_test_51MWOtgGtTsebDkQwsne9XO59N9J9PJvoAMa1dr01kQyDSMptnsh5FiWXOPF6HLexmIoasGQYtAsueIP2Xl6oaL3a00p8Yuhir3"),this.fetchCartTotal()},watch:{currency(e,t){this.fetchCartTotal(),this.selectedPaymentMethod===2&&e==="USD"&&(this.selectedPaymentMethod=null)},selectedPaymentMethod(e){e===1&&this.$nextTick(()=>{this.initStripeElements()})}},methods:{selectPaymentMethod(e){this.selectedPaymentMethod=e},async initStripeElements(){if(!document.getElementById("card-element"))return;const e=await this.stripePromise;this.stripeElements=e.elements();const t=this.stripeElements.create("card",{style:{base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}}});t.mount("#card-element"),t.on("change",s=>{const o=document.getElementById("card-errors");s.error?o.textContent=s.error.message:o.textContent=""}),this.cardElement=t},async initiateTabbyPayment(){var e,t,s;this.loading=!0;try{if(!this.shippingDetails.addressId){this.$toast.error("The address id field is required.");return}const o=localStorage.getItem("auth_user");if(!o){this.$toast.error("User authentication required");return}const r=JSON.parse(o),n=r==null?void 0:r.id;if(!n){this.$toast.error("User authentication required");return}if(!Array.isArray(this.cartItems)||this.cartItems.length===0){this.$toast.error("No items in cart");return}const a=parseFloat(this.totalAmount),l=this.cartItems.map(m=>{var I,D,c,p;return{product_id:(I=m.product)==null?void 0:I.id,product_name:((D=m.product)==null?void 0:D.name)||"",quantity:parseInt(m.quantity)||0,price:parseFloat((c=m.product)==null?void 0:c.converted_price)||parseFloat(m.price)||0,subtotal:(parseFloat((p=m.product)==null?void 0:p.converted_price)||parseFloat(m.price)||0)*(parseInt(m.quantity)||0)}}).filter(m=>m.product_id&&m.quantity>0),f=((e=this.user)==null?void 0:e.name)||(r==null?void 0:r.name)||"Guest",S=((t=this.user)==null?void 0:t.email)||(r==null?void 0:r.email)||"",k=((s=this.user)==null?void 0:s.phone)||(r==null?void 0:r.phone)||"",g={user_id:n,total_price:a,delivery_charge:parseFloat(this.deliveryCharge),shipping_address:this.shippingDetails.address||"",address_id:this.shippingDetails.addressId,items:l,user:{name:f,email:S,phone:k}},A={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},y=await _.post(`${v}/api/payment/tabby/send`,g,{headers:A});y.data.status==="success"&&(window.location.href=y.data.data.payment_url)}catch(o){console.error("Tabby Payment Error:",o),this.$toast.error((o==null?void 0:o.message)||"Unexpected Tabby payment error")}finally{this.loading=!1}},original_totalPrice(){return this.cartItems.reduce((e,t)=>{var r;const s=parseFloat((r=t.product)==null?void 0:r.price)||0,o=parseInt(t.quantity)||0;return e+s*o},0).toFixed(2)},async placeOrder(){var e,t,s,o,r,n,a,l,f,S,k,g,A;try{if(this.loading=!0,!this.shippingDetails.addressId){this.$toast.error("The address id field is required.");return}let y;try{const c=localStorage.getItem("auth_user");if(c){const p=JSON.parse(c);y=p==null?void 0:p.id}}catch(c){console.error("Error parsing auth_user:",c),this.$toast.error("Error getting user information");return}if(!y){this.$toast.error("User authentication required");return}if(!Array.isArray(this.cartItems)||this.cartItems.length===0){this.$toast.error("No items in cart");return}const m=parseFloat(this.totalAmount),I={user_id:y,order:{status:"pending",payment_method:this.selectedPaymentMethod===1?"stripe":this.selectedPaymentMethod===2?"tabby":"cod",shipping_address:this.shippingDetails.address||"",address_id:this.shippingDetails.addressId,items:this.cartItems.map(c=>{var p,P,N,M;return{product_id:(p=c.product)==null?void 0:p.id,product_name:((P=c.product)==null?void 0:P.name)||"",quantity:parseInt(c.quantity)||0,price:parseFloat((N=c.product)==null?void 0:N.converted_price)||parseFloat(c.price)||0,subtotal:(parseFloat((M=c.product)==null?void 0:M.converted_price)||parseFloat(c.price)||0)*(parseInt(c.quantity)||0),created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}).filter(c=>c.product_id&&c.quantity>0),total_price:m,delivery_charge:parseFloat(this.deliveryCharge),created_at:new Date().toISOString(),updated_at:new Date().toISOString(),original_total_price:this.original_totalPrice(),original_currency:this.currency}};if(!I.order.items.length){this.$toast.error("Invalid order items");return}const D={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(this.selectedPaymentMethod===1){const c=await _.post(`${v}/api/payment/process`,{...I,amount:m,currency:this.currency,delivery_charge:parseFloat(this.deliveryCharge),payment_method:"stripe"},{headers:D});if((e=c==null?void 0:c.data)!=null&&e.success&&((t=c==null?void 0:c.data)!=null&&t.url)){window.location.href=c.data.url;return}else throw new Error(((s=c==null?void 0:c.data)==null?void 0:s.error)||((o=c==null?void 0:c.data)==null?void 0:o.message)||this.$t("checkout.errorCreatingPaymentSession"))}if(this.selectedPaymentMethod===2&&!currency==="USD"){const c=await _.post(`${v}/api/payment/process`,{user_id:y,delivery_charge:parseFloat(this.deliveryCharge),payment_method:"tabby",order:{status:"pending",payment_method:"tabby",shipping_address:this.shippingDetails.address||"",address_id:this.shippingDetails.addressId,items:this.cartItems.map(p=>{var P,N,M,R;return{product_id:(P=p.product)==null?void 0:P.id,product_name:((N=p.product)==null?void 0:N.name)||"",quantity:parseInt(p.quantity)||0,price:parseFloat((M=p.product)==null?void 0:M.converted_price)||parseFloat(p.price)||0,subtotal:(parseFloat((R=p.product)==null?void 0:R.converted_price)||parseFloat(p.price)||0)*(parseInt(p.quantity)||0)}}).filter(p=>p.product_id&&p.quantity>0),total_price:m,delivery_charge:parseFloat(this.deliveryCharge)},user:{name:this.user.name,email:this.user.email,phone:this.user.phone}},{headers:D});if(((r=c==null?void 0:c.data)==null?void 0:r.status)==="success"&&((n=c.data.data)!=null&&n.payment_url)){this.$toast.success("Redirecting to Tabby..."),window.location.href=c.data.data.payment_url;return}else throw new Error(((a=c==null?void 0:c.data)==null?void 0:a.message)||((l=c==null?void 0:c.data)==null?void 0:l.error)||"Error creating Tabby session.")}if(this.selectedPaymentMethod===3){const c=await _.post(`${v}/api/orders`,I,{headers:D});if(((f=c==null?void 0:c.data)==null?void 0:f.status)==="success"){this.$toast.success(this.$t("checkout.orderPlacedSuccessfully")),window.location.href="/orders/user";return}else{const p=((S=c==null?void 0:c.data)==null?void 0:S.message)||((k=c==null?void 0:c.data)==null?void 0:k.error)||"Error placing order";throw new Error(p)}}}catch(y){console.error("Error placing order:",y);let m="Unexpected error while placing your order.";try{(g=y==null?void 0:y.response)!=null&&g.data?m=y.response.data.message||y.response.data.error||y.message||m:y!=null&&y.message&&(m=y.message)}catch(I){console.warn("Error extracting message:",I)}(A=this==null?void 0:this.$toast)!=null&&A.error?this.$toast.error(m):window.location.href="/orders/user"}finally{this.loading=!1}},async createOrder(){if(!this.shippingDetails.addressId){this.$toast.error("The address id field is required.");return}const e=this.cartItems.reduce((o,r)=>o+r.price*r.quantity,0),t=this.selectedPaymentMethod===3?"cod":String(this.selectedPaymentMethod),s={shipping_details:this.shippingDetails,address_id:this.shippingDetails.addressId,payment_method:t,items:this.cartItems.map(o=>({product_id:o.product.id,quantity:o.quantity,price:o.price,subtotal:o.price*o.quantity})),total_price:e,delivery_charge:parseFloat(this.deliveryCharge)};try{const o=await _.post(`${v}/api/orders`,s,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(o.data.success)window.location.href="/orders/user";else throw new Error(o.data.error||this.$t("checkout.errorPlacingOrder"))}catch(o){console.error(o),this.$t("checkout.errorPlacingOrder")}},async fetchCartTotal(){var e,t,s;try{const o=localStorage.getItem("auth_token"),n=((s=(t=(e=(await _.get("https://backend.webenia.org/api/cart-items",{headers:{Authorization:`Bearer ${o}`}})).data)==null?void 0:e.data)==null?void 0:t.original)==null?void 0:s.data)||[];this.apiCartTotal=n.reduce((a,l)=>a+Number(l.converted_total),0)}catch(o){console.error("Error fetching cart items:",o),this.apiCartTotal=0}},getCountryCode(e){const t={"United States":"US","United Kingdom":"GB",Egypt:"EG","Saudi Arabia":"SA","United Arab Emirates":"AE",Kuwait:"KW",Qatar:"QA",Bahrain:"BH",Oman:"OM",Jordan:"JO",Lebanon:"LB",Iraq:"IQ",Syria:"SY",Yemen:"YE",Libya:"LY",Sudan:"SD",Morocco:"MA",Algeria:"DZ",Tunisia:"TN",Palestine:"PS",Israel:"IL",Turkey:"TR",Iran:"IR",Pakistan:"PK",India:"IN",China:"CN",Japan:"JP","South Korea":"KR",Singapore:"SG",Malaysia:"MY",Indonesia:"ID",Australia:"AU","New Zealand":"NZ",Canada:"CA",Mexico:"MX",Brazil:"BR",Argentina:"AR","South Africa":"ZA",Nigeria:"NG",Kenya:"KE",Ghana:"GH",Ethiopia:"ET",Tanzania:"TZ",Uganda:"UG",Rwanda:"RW",Senegal:"SN","Côte d'Ivoire":"CI",Cameroon:"CM",Angola:"AO",Mozambique:"MZ",Madagascar:"MG",Mauritius:"MU",Seychelles:"SC",Comoros:"KM",Djibouti:"DJ",Eritrea:"ER",Somalia:"SO","South Sudan":"SS",Chad:"TD",Niger:"NE",Mali:"ML","Burkina Faso":"BF",Benin:"BJ",Togo:"TG",Guinea:"GN","Guinea-Bissau":"GW","Sierra Leone":"SL",Liberia:"LR","Cape Verde":"CV","São Tomé and Príncipe":"ST","Equatorial Guinea":"GQ",Gabon:"GA","Republic of the Congo":"CG","Democratic Republic of the Congo":"CD","Central African Republic":"CF",Burundi:"BI",Zambia:"ZM",Zimbabwe:"ZW",Malawi:"MW",Namibia:"NA",Botswana:"BW",Lesotho:"LS",Eswatini:"SZ",Mauritania:"MR","Western Sahara":"EH","The Gambia":"GM","Guinea-Bissau":"GW","Sierra Leone":"SL",Liberia:"LR","Cape Verde":"CV","São Tomé and Príncipe":"ST","Equatorial Guinea":"GQ",Gabon:"GA","Republic of the Congo":"CG","Democratic Republic of the Congo":"CD","Central African Republic":"CF",Burundi:"BI",Zambia:"ZM",Zimbabwe:"ZW",Malawi:"MW",Namibia:"NA",Botswana:"BW",Lesotho:"LS",Eswatini:"SZ",Mauritania:"MR","Western Sahara":"EH","The Gambia":"GM"};if(/^[A-Z]{2}$/.test(e))return e;const s=t[e];return s||null}},computed:{subTotal(){return this.apiCartTotal.toFixed(2)},deliveryCharge(){const e=this.shippingDetails.country_id;let t;return e===57?t=10:t=20,pt(t,this.currency).toFixed(2)},taxAmount(){return 0},totalAmount(){const e=parseFloat(this.apiCartTotal),t=parseFloat(this.deliveryCharge),s=parseFloat(this.taxAmount);return(e+t+s).toFixed(2)}},onMounted(){window.addEventListener("currency-changed",()=>{fetchCartTotal()})}},mt={class:"checkout-step"},yt={class:"payment-methods"},gt=["disabled","onClick"],_t=["src","alt"],ft={key:0,class:"stripe-container"},vt={class:"order-summary"},bt={class:"summary-details"},St={class:"total-amount"},kt={class:"button-group"},It=["disabled"],Ct={key:0},wt={key:1};function $t(e,t,s,o,r,n){return u(),h("div",mt,[i("h2",null,d(e.$t("checkout.payment")),1),i("div",yt,[(u(!0),h(E,null,L(r.paymentMethods,a=>(u(),h("button",{disabled:a.name==="Tabby"&&s.currency==="USD",key:a.id,class:b(["payment-method",{active:r.selectedPaymentMethod===a.id,[a.class]:s.currency==="USD"}]),onClick:l=>n.selectPaymentMethod(a.id)},[i("img",{src:a.icon,alt:a.name,style:K(a.style),height:"40",width:"40"},null,12,_t),i("span",null,d(a.name),1)],10,gt))),128))]),r.selectedPaymentMethod===1?(u(),h("div",ft,t[2]||(t[2]=[i("div",{class:"card-element-container"},[i("div",{id:"card-element",class:"card-element"}),i("div",{id:"card-errors",class:"card-errors",role:"alert"})],-1)]))):w("",!0),i("div",vt,[i("h3",null,d(e.$t("checkout.orderSummary")),1),i("div",bt,[i("p",null,d(s.cartItems.length)+" "+d(e.$t("checkout.items")),1),i("p",null,d(e.$t("checkout.deliveryTo"))+": "+d(s.shippingDetails.address),1),i("p",null,d(e.$t("checkout.subtotal"))+": "+d(r.apiCartTotal)+" "+d(s.currency),1),i("p",null,d(e.$t("checkout.deliveryCharge"))+": "+d(n.deliveryCharge)+" "+d(s.currency),1),i("div",St,d(e.$t("checkout.totalAmount"))+": "+d(n.totalAmount)+" "+d(s.currency),1)])]),i("div",kt,[i("button",{class:"btn-secondary",onClick:t[0]||(t[0]=a=>e.$emit("previous-step"))},d(e.$t("checkout.back")),1),i("button",{class:"btn-primary",disabled:!r.selectedPaymentMethod||r.loading,onClick:t[1]||(t[1]=a=>r.selectedPaymentMethod===2?n.initiateTabbyPayment():n.placeOrder())},[r.loading?(u(),h("span",Ct,d(e.$t("checkout.processing"))+"...",1)):(u(),h("span",wt,d(e.$t("checkout.placeOrder")),1))],8,It)])])}const At=U(ht,[["render",$t],["__scopeId","data-v-1adb9b7f"]]);const Dt={name:"Checkout",components:{Header:X,CheckoutStepper:ne,CartReview:Ie,ShippingDetails:Ye,PaymentStep:At,Footer:Y},data(){return{step:1,cartItems:[],shippingCost:0,shippingDetails:{fullName:"",address:"",city:"",postalCode:"",phone:"",buildingName:"",floorNumber:"",apartmentNumber:"",landmark:"",street:"",country:""}}},computed:{currentLang(){return localStorage.getItem("lang")||"en"},currency(){if(this.cartItems.length>0){if(this.cartItems[0].currency_code)return this.cartItems[0].currency_code;const e=(this.currentLang==="ar"?this.cartItems[0].currency.name_ar:this.cartItems[0].currency.name_en).toLowerCase();return{"us dollar":"usd",usd:"usd","british pound":"gbp",gbp:"gbp",euro:"eur",eur:"eur","درهم إماراتي":"aed",aed:"aed","جنيه مصري":"egp",egp:"egp"}[e]||"usd"}return"usd"},total(){const e=this.cartItems.reduce((t,s)=>t+parseFloat(s.converted_price)*s.quantity,0);return parseFloat((e+this.shippingCost).toFixed(2))}},created(){this.fetchCartItems()},methods:{async fetchCartItems(){try{const e=JSON.parse(localStorage.getItem("selectedCurrency"))||{code:"USD"},t=await _.get(`${v}/api/cart-items`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,Currency:e.code}});this.cartItems=t.data.data.original.data}catch(e){console.error("Error fetching cart items:",e),this.$toast.error(this.$t("checkout.errorFetchingCart"))}},updateCart(){this.fetchCartItems()},nextStep(){this.step<3&&this.step++},previousStep(){this.step>1&&this.step--},async handleOrderPlaced(){const e={payment_method:this.cartItems[0].payment_method||"paypal",user_id:localStorage.getItem("user_id"),order:{status:"pending",payment_method:this.selectedPaymentMethod===1?"stripe":"cash",shipping_address:`${this.shippingDetails.street}, ${this.shippingDetails.city}, ${this.shippingDetails.country}`},items:this.cartItems.map(t=>({product_id:t.product_id,product_name:t.product_name,quantity:t.quantity,price:t.price}))};try{const t=await _.post(`${v}/api/orders`,e,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});this.$router.push("/order-confirmation")}catch(t){console.error("Error placing order:",t),this.$toast.error(this.$t("checkout.errorPlacingOrder"))}}},mounted(){window.addEventListener("currency-changed",()=>{this.fetchCartItems()})}},qt={class:"checkout-container"};function Et(e,t,s,o,r,n){const a=$("Header"),l=$("CheckoutStepper"),f=$("CartReview"),S=$("ShippingDetails"),k=$("PaymentStep"),g=$("Footer");return u(),h(E,null,[O(a),i("div",qt,[O(l,{step:r.step},null,8,["step"]),r.step===1?(u(),V(f,{key:0,"cart-items":r.cartItems,"shipping-cost":r.shippingCost,currency:n.currency,onNextStep:n.nextStep,onUpdateCart:n.updateCart},null,8,["cart-items","shipping-cost","currency","onNextStep","onUpdateCart"])):w("",!0),r.step===2?(u(),V(S,{key:1,modelValue:r.shippingDetails,"onUpdate:modelValue":t[0]||(t[0]=A=>r.shippingDetails=A),onNextStep:n.nextStep,onPreviousStep:n.previousStep},null,8,["modelValue","onNextStep","onPreviousStep"])):w("",!0),r.step===3?(u(),V(k,{key:2,"cart-items":r.cartItems,"shipping-details":r.shippingDetails,total:n.total,currency:n.currency,onPreviousStep:n.previousStep,onOrderPlaced:n.handleOrderPlaced},null,8,["cart-items","shipping-details","total","currency","onPreviousStep","onOrderPlaced"])):w("",!0)]),O(g)],64)}const Nt=U(Dt,[["render",Et],["__scopeId","data-v-4a8de943"]]);export{Nt as default};
