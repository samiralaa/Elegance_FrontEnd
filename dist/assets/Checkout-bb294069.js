import{_ as M,o as u,c as y,a,t as d,n as S,A as f,b as v,r as $,F as N,d as G,w,v as D,e as U,f as C,g as z,h as R,i as J,H,j as O}from"./index-ae750e8a.js";const K={name:"CheckoutStepper",props:{step:{type:Number,required:!0}}},X={class:"stepper"},Y={class:"step-label"},ee={class:"step-label"},te={class:"step-label"};function se(e,t,r,o,s,i){return u(),y("div",X,[a("div",{class:S(["step",{active:r.step>=1,completed:r.step>1}])},[t[0]||(t[0]=a("div",{class:"step-number"},"1",-1)),a("div",Y,d(e.$t("checkout.cart")),1)],2),a("div",{class:S(["step-line",{active:r.step>1}])},null,2),a("div",{class:S(["step",{active:r.step>=2,completed:r.step>2}])},[t[1]||(t[1]=a("div",{class:"step-number"},"2",-1)),a("div",ee,d(e.$t("checkout.shipping")),1)],2),a("div",{class:S(["step-line",{active:r.step>2}])},null,2),a("div",{class:S(["step",{active:r.step>=3}])},[t[2]||(t[2]=a("div",{class:"step-number"},"3",-1)),a("div",te,d(e.$t("checkout.payment")),1)],2)])}const re=M(K,[["render",se],["__scopeId","data-v-4a5013a8"]]);const ae={name:"CartReview",props:{cartItems:{type:Array,required:!0},shippingCost:{type:Number,required:!0},currency:{type:String,required:!0}},computed:{currentLang(){return localStorage.getItem("lang")||"en"},subtotal(){return this.cartItems.reduce((e,t)=>e+parseFloat(t.price)*t.quantity,0).toFixed(2)},total(){return(parseFloat(this.subtotal)+this.shippingCost).toFixed(2)}},methods:{getProductImage(e){return e.images&&Array.isArray(e.images)?`${f}/public/storage/${e.images[0]}`:`${f}/images/default.jpg`},async updateCartItemQuantity(e){var t,r,o;e.quantity<1&&(e.quantity=1),e.quantity>99&&(e.quantity=99);try{const s=await v.post(`${f}/api/cart-items/${e.id}`,{quantity:e.quantity},{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,"Content-Type":"application/json"}});if(s.data){alert("etst");const n=s.data.data;e.quantity=(n==null?void 0:n.quantity)??e.quantity,e.price=(n==null?void 0:n.price)??e.price,console.log("test");const l=this.$t("checkout.quantityUpdated")||"Quantity updated successfully";this.$toast.success(l)}else{const n=((t=s==null?void 0:s.data)==null?void 0:t.message)||this.$t("checkout.errorUpdatingQuantity");this.$toast.error(n)}this.$emit("update-cart")}catch(s){console.error("Error updating quantity:",s);let i="Error updating quantity";(o=(r=s==null?void 0:s.response)==null?void 0:r.data)!=null&&o.message?i=s.response.data.message:this.$t&&this.$t("checkout.errorUpdatingQuantity")&&(i=this.$t("checkout.errorUpdatingQuantity")),this.$toast.error(i)}},async updateCartItemQuantity(e){var t,r,o;e.quantity<1&&(e.quantity=1),e.quantity>99&&(e.quantity=99);try{const s=await v.post(`${f}/api/cart-items/${e.id}`,{quantity:e.quantity},{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,"Content-Type":"application/json"}}),i=(t=s==null?void 0:s.data)==null?void 0:t.data;if(i){e.quantity=i.quantity,e.price=i.price,e.converted_price=i.converted_price,e.converted_total=i.converted_total,e.currency_code=i.currency_code,i.product&&(e.product=i.product);const n=this.$t("checkout.quantityUpdated")||"Quantity updated successfully";this.$toast.success(n),this.$emit("update-cart",[...this.cartItems])}else{const n=this.$t("checkout.errorUpdatingQuantity")||"Error updating quantity";this.$toast.error(n)}}catch(s){console.error("Error updating quantity:",s);const i=((o=(r=s==null?void 0:s.response)==null?void 0:r.data)==null?void 0:o.message)||this.$t("checkout.errorUpdatingQuantity")||"Error updating quantity";this.$toast.error(i)}},async increaseQuantity(e){e.quantity<99?(e.quantity++,await this.updateCartItemQuantity(e)):this.$toast.warning(this.$t("checkout.maxQuantity"))},async decreaseQuantity(e){e.quantity>1?(e.quantity--,await this.updateCartItemQuantity(e)):this.$toast.warning(this.$t("checkout.minimumQuantity"))},async removeItem(e){try{await v.delete(`${f}/api/cart-items/${e}`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}}),this.$emit("update-cart",this.cartItems.filter(t=>t.id!==e)),this.$toast.success(this.$t("checkout.itemRemoved"))}catch(t){console.error("Error removing item:",t),this.$toast.error("this.$t('checkout.errorRemovingItem')")}}}},ie={class:"checkout-step"},ne={class:"cart-items"},oe=["src","alt"],de={class:"item-details"},ce={class:"item-price"},le={class:"quantity-controls"},ue=["onClick","disabled"],pe=["onUpdate:modelValue","onChange","onInput"],he=["onClick","disabled"],me=["onClick"],ye={class:"cart-summary"},ge={class:"summary-row"},_e={class:"summary-row"},ve={class:"summary-row total"},fe=["disabled"];function be(e,t,r,o,s,i){const n=$("fa");return u(),y("div",ie,[a("h2",null,d(e.$t("checkout.reviewCart")),1),a("div",ne,[(u(!0),y(N,null,G(r.cartItems,l=>{var g,k,I;return u(),y("div",{key:l.id,class:"cart-item"},[a("img",{src:i.getProductImage(l),alt:((g=l.product)==null?void 0:g.name_en)||"",class:"item-image"},null,8,oe),a("div",de,[a("h3",null,d(i.currentLang==="ar"?(k=l.product)==null?void 0:k.name_ar:(I=l.product)==null?void 0:I.name_en),1),a("p",ce,d(l.price)+" "+d(r.currency),1),a("div",le,[a("button",{onClick:_=>i.decreaseQuantity(l),disabled:l.quantity<=1},"-",8,ue),w(a("input",{class:"qty-number",type:"number",min:"1",max:"99","onUpdate:modelValue":_=>l.quantity=_,onChange:_=>i.updateCartItemQuantity(l),onInput:_=>l.quantity=Math.min(Math.max(l.quantity,1),99)},null,40,pe),[[D,l.quantity,void 0,{number:!0}]]),a("button",{onClick:_=>i.increaseQuantity(l),disabled:l.quantity>=99},"+",8,he)])]),a("button",{class:"remove-item",onClick:_=>i.removeItem(l.id)},[U(n,{icon:"trash"})],8,me)])}),128))]),a("div",ye,[a("div",ge,[a("span",null,d(e.$t("checkout.subtotal")),1),a("span",null,d(i.subtotal)+" "+d(r.currency),1)]),a("div",_e,[a("span",null,d(e.$t("checkout.shipping")),1),a("span",null,d(r.shippingCost)+" "+d(r.currency),1)]),a("div",ve,[a("span",null,d(e.$t("checkout.total")),1),a("span",null,d(i.total)+" "+d(r.currency),1)])]),a("button",{class:"btn-primary",onClick:t[0]||(t[0]=l=>e.$emit("next-step")),disabled:!r.cartItems.length},d(e.$t("checkout.continueToShipping")),9,fe)])}const Se=M(ae,[["render",be],["__scopeId","data-v-e289d39d"]]);const ke={name:"ShippingDetails",props:{modelValue:{type:Object,required:!0},currency:{type:String,required:!1}},data(){return{savedAddresses:[],selectedAddressId:null,loading:!1,error:null,selectedAddress:null,isNewAddress:!1,countries:[],countryLoading:!1}},computed:{shippingDetails:{get(){return this.modelValue},set(e){this.$emit("update:modelValue",e)}},isValid(){return this.isNewAddress?this.shippingDetails.buildingName&&this.shippingDetails.floorNumber&&this.shippingDetails.apartmentNumber&&this.shippingDetails.landmark&&this.shippingDetails.postalCode&&this.shippingDetails.cityId&&this.shippingDetails.countryId:this.selectedAddressId!==null}},methods:{async fetchSavedAddresses(){var e,t;this.loading=!0;try{const r=await v.get("https://backend.webenia.org/api/address",{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,"Content-Type":"application/json"}});if(r.data.status&&r.data.data){this.savedAddresses=r.data.data;const o=this.savedAddresses.find(s=>s.is_primary);o&&this.selectAddress(o)}}catch(r){console.error("Error fetching addresses:",r),this.error=((t=(e=r.response)==null?void 0:e.data)==null?void 0:t.message)||r.message}finally{this.loading=!1}},selectAddress(e){this.selectedAddressId=e.id,this.selectedAddress=e,this.isNewAddress=!1,this.shippingDetails={...this.shippingDetails,addressId:e.id}},async saveNewAddress(){var e,t;try{const r=localStorage.getItem("auth_token");let o=1;if(r)try{o=JSON.parse(atob(r.split(".")[1])).sub||1}catch(n){console.error("Error decoding token:",n)}const s={user_id:o,city_id:this.shippingDetails.cityId||1,country_id:this.shippingDetails.countryId||1,building_name:this.shippingDetails.buildingName,floor_number:this.shippingDetails.floorNumber,apartment_number:this.shippingDetails.apartmentNumber,landmark:this.shippingDetails.landmark,postal_code:this.shippingDetails.postalCode,is_primary:this.savedAddresses.length===0},i=await v.post("https://backend.webenia.org/api/address",s,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,"Content-Type":"application/json"}});if(i.data.status){const n=i.data.data;return this.savedAddresses.push(n),this.selectAddress(n),n.id}throw new Error(i.data.message||"Failed to save address")}catch(r){throw console.error("Error saving address:",r),this.error=((t=(e=r.response)==null?void 0:e.data)==null?void 0:t.message)||r.message,r}},async handleSubmit(){if(this.isValid)try{let e=this.selectedAddressId;this.isNewAddress&&(e=await this.saveNewAddress());const t={...this.shippingDetails,addressId:e};this.$emit("next-step",t)}catch(e){const t=e.message||this.$t("checkout.errorSavingAddress");this.$toast.error(t)}},toggle(){this.isOpen=!this.isOpen},selectOption(e){this.selectedValue=e.value,this.$emit("update:modelValue",e.value),this.isOpen=!1},async fetchCountries(){var e;this.countryLoading=!0;try{const t=await v.get("https://backend.webenia.org/api/countries");this.countries=((e=t.data)==null?void 0:e.data)||[]}catch(t){console.error("Error fetching countries:",t)}finally{this.countryLoading=!1}}},mounted(){this.fetchSavedAddresses(),this.fetchCountries()}},Ie={class:"checkout-step"},we={class:"address-type-selector"},Ce={key:0,class:"saved-addresses"},$e={class:"address-list"},Ae=["onClick"],De={class:"address-info"},qe={key:0,class:"primary-badge"},Ee={class:"address-actions"},Pe={class:"form-group"},Ne={for:"country"},Me={key:0,disabled:""},Le=["value"],Te={class:"form-group"},Be={for:"city"},Ge={class:"form-group"},Ue={for:"buildingName"},Oe={class:"form-group"},Ve={for:"floorNumber"},Re={class:"form-group"},Fe={for:"apartmentNumber"},je={class:"form-group"},Qe={for:"landmark"},We={class:"form-group"},Ze={for:"postalCode"},xe={class:"button-group"},ze=["disabled"];function Je(e,t,r,o,s,i){return u(),y("div",Ie,[a("h2",null,d(e.$t("checkout.shippingDetails")),1),a("div",we,[a("button",{class:S(["type-btn",{active:!s.isNewAddress}]),onClick:t[0]||(t[0]=n=>s.isNewAddress=!1)},d(e.$t("checkout.selectExistingAddress")),3),a("button",{class:S(["type-btn",{active:s.isNewAddress}]),onClick:t[1]||(t[1]=n=>s.isNewAddress=!0)},d(e.$t("checkout.createNewAddress")),3)]),!s.isNewAddress&&s.savedAddresses.length?(u(),y("div",Ce,[a("h3",null,d(e.$t("checkout.savedAddresses")),1),a("div",$e,[(u(!0),y(N,null,G(s.savedAddresses,n=>(u(),y("div",{key:n.id,class:S(["address-card",{selected:s.selectedAddressId===n.id}]),onClick:l=>i.selectAddress(n)},[a("div",De,[a("p",null,[a("strong",null,d(n.building_name),1)]),a("p",null,d(n.landmark),1),a("p",null,"Floor "+d(n.floor_number)+", Apartment "+d(n.apartment_number),1),a("p",null,"Postal Code: "+d(n.postal_code),1),n.is_primary?(u(),y("p",qe,d(e.$t("checkout.primaryAddress")),1)):C("",!0)]),a("div",Ee,[a("button",{class:S(["btn-select",{selected:s.selectedAddressId===n.id}])},d(s.selectedAddressId===n.id?e.$t("checkout.selected"):e.$t("checkout.select")),3)])],10,Ae))),128))])])):C("",!0),s.isNewAddress?(u(),y("form",{key:1,onSubmit:t[9]||(t[9]=z((...n)=>i.handleSubmit&&i.handleSubmit(...n),["prevent"])),class:"shipping-form"},[a("div",Pe,[a("label",Ne,d(e.$t("checkout.country")),1),w(a("select",{id:"country","onUpdate:modelValue":t[2]||(t[2]=n=>i.shippingDetails.countryId=n),required:""},[s.countryLoading?(u(),y("option",Me,"Loading...")):C("",!0),(u(!0),y(N,null,G(s.countries,n=>(u(),y("option",{key:n.id,value:n.id},d(n.name_en||n.name_ar),9,Le))),128))],512),[[R,i.shippingDetails.countryId]])]),a("div",Te,[a("label",Be,d(e.$t("checkout.city")),1),w(a("select",{id:"city",class:"form-select","aria-label":"Default select example","onUpdate:modelValue":t[3]||(t[3]=n=>i.shippingDetails.cityId=n),required:""},t[12]||(t[12]=[J('<option value="1" class="option" data-v-2c790473>Dubai</option><option value="2" class="option" data-v-2c790473>Abu Dhabi</option><option value="3" class="option" data-v-2c790473>Sharjah</option><option value="4" class="option" data-v-2c790473>Ajman</option><option value="5" class="option" data-v-2c790473>Ras Al Khaimah</option><option value="6" class="option" data-v-2c790473>Umm Al Quwain</option><option value="7" class="option" data-v-2c790473>Fujairah</option>',7)]),512),[[R,i.shippingDetails.cityId]])]),a("div",Ge,[a("label",Ue,d(e.$t("checkout.buildingName")),1),w(a("input",{type:"text",id:"buildingName","onUpdate:modelValue":t[4]||(t[4]=n=>i.shippingDetails.buildingName=n),required:""},null,512),[[D,i.shippingDetails.buildingName]])]),a("div",Oe,[a("label",Ve,d(e.$t("checkout.floorNumber")),1),w(a("input",{type:"text",id:"floorNumber","onUpdate:modelValue":t[5]||(t[5]=n=>i.shippingDetails.floorNumber=n),required:""},null,512),[[D,i.shippingDetails.floorNumber]])]),a("div",Re,[a("label",Fe,d(e.$t("checkout.apartmentNumber")),1),w(a("input",{type:"text",id:"apartmentNumber","onUpdate:modelValue":t[6]||(t[6]=n=>i.shippingDetails.apartmentNumber=n),required:""},null,512),[[D,i.shippingDetails.apartmentNumber]])]),a("div",je,[a("label",Qe,d(e.$t("checkout.landmark")),1),w(a("input",{type:"text",id:"landmark","onUpdate:modelValue":t[7]||(t[7]=n=>i.shippingDetails.landmark=n),required:""},null,512),[[D,i.shippingDetails.landmark]])]),a("div",We,[a("label",Ze,d(e.$t("checkout.postalCode")),1),w(a("input",{type:"text",id:"postalCode","onUpdate:modelValue":t[8]||(t[8]=n=>i.shippingDetails.postalCode=n),required:""},null,512),[[D,i.shippingDetails.postalCode]])])],32)):C("",!0),a("div",xe,[a("button",{type:"button",class:"btn-secondary",onClick:t[10]||(t[10]=n=>e.$emit("previous-step"))},d(e.$t("checkout.back")),1),a("button",{type:"button",class:"btn-primary",onClick:t[11]||(t[11]=(...n)=>i.handleSubmit&&i.handleSubmit(...n)),disabled:!i.isValid},d(e.$t("checkout.continueToPayment")),9,ze)])])}const He=M(ke,[["render",Je],["__scopeId","data-v-2c790473"]]);var Q="basil",Ke=function(t){return t===3?"v3":t},W="https://js.stripe.com",Xe="".concat(W,"/").concat(Q,"/stripe.js"),Ye=/^https:\/\/js\.stripe\.com\/v3\/?(\?.*)?$/,et=/^https:\/\/js\.stripe\.com\/(v3|[a-z]+)\/stripe\.js(\?.*)?$/,F="loadStripe.setLoadParameters was called but an existing Stripe.js script already exists in the document; existing script parameters will be used",tt=function(t){return Ye.test(t)||et.test(t)},st=function(){for(var t=document.querySelectorAll('script[src^="'.concat(W,'"]')),r=0;r<t.length;r++){var o=t[r];if(tt(o.src))return o}return null},j=function(t){var r=t&&!t.advancedFraudSignals?"?advancedFraudSignals=false":"",o=document.createElement("script");o.src="".concat(Xe).concat(r);var s=document.head||document.body;if(!s)throw new Error("Expected document.body not to be null. Stripe.js requires a <body> element.");return s.appendChild(o),o},rt=function(t,r){!t||!t._registerWrapper||t._registerWrapper({name:"stripe-js",version:"7.3.1",startTime:r})},E=null,T=null,B=null,at=function(t){return function(r){t(new Error("Failed to load Stripe.js",{cause:r}))}},it=function(t,r){return function(){window.Stripe?t(window.Stripe):r(new Error("Stripe.js not available"))}},nt=function(t){return E!==null?E:(E=new Promise(function(r,o){if(typeof window>"u"||typeof document>"u"){r(null);return}if(window.Stripe&&t&&console.warn(F),window.Stripe){r(window.Stripe);return}try{var s=st();if(s&&t)console.warn(F);else if(!s)s=j(t);else if(s&&B!==null&&T!==null){var i;s.removeEventListener("load",B),s.removeEventListener("error",T),(i=s.parentNode)===null||i===void 0||i.removeChild(s),s=j(t)}B=it(r,o),T=at(o),s.addEventListener("load",B),s.addEventListener("error",T)}catch(n){o(n);return}}),E.catch(function(r){return E=null,Promise.reject(r)}))},ot=function(t,r,o){if(t===null)return null;var s=r[0],i=s.match(/^pk_test/),n=Ke(t.version),l=Q;i&&n!==l&&console.warn("Stripe.js@".concat(n," was loaded on the page, but @stripe/stripe-js@").concat("7.3.1"," expected Stripe.js@").concat(l,". This may result in unexpected behavior. For more information, see https://docs.stripe.com/sdks/stripejs-versioning"));var g=t.apply(void 0,r);return rt(g,o),g},P,Z=!1,x=function(){return P||(P=nt(null).catch(function(t){return P=null,Promise.reject(t)}),P)};Promise.resolve().then(function(){return x()}).catch(function(e){Z||console.warn(e)});var dt=function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];Z=!0;var s=Date.now();return x().then(function(i){return ot(i,r,s)})};const ct={name:"PaymentStep",props:{cartItems:{type:Array,required:!0},shippingDetails:{type:Object,required:!0},total:{type:Number,required:!0},currency:{type:String,required:!0}},data(){return{selectedPaymentMethod:null,paymentMethods:[{id:1,name:"Stripe",icon:"credit-card"},{id:2,name:"Tabby",icon:"credit-card-alt"},{id:3,name:"Cash on Delivery",icon:"money-bill"}],loading:!1,stripePromise:null,stripeClientSecret:null,stripeElements:null,cardElement:null}},created(){this.stripePromise=dt("pk_test_51MWOtgGtTsebDkQwsne9XO59N9J9PJvoAMa1dr01kQyDSMptnsh5FiWXOPF6HLexmIoasGQYtAsueIP2Xl6oaL3a00p8Yuhir3")},watch:{selectedPaymentMethod(e){e===1&&this.$nextTick(()=>{this.initStripeElements()})}},methods:{selectPaymentMethod(e){this.selectedPaymentMethod=e},async initStripeElements(){if(!document.getElementById("card-element"))return;const e=await this.stripePromise;this.stripeElements=e.elements();const t=this.stripeElements.create("card",{style:{base:{color:"#32325d",fontFamily:'"Helvetica Neue", Helvetica, sans-serif',fontSmoothing:"antialiased",fontSize:"16px","::placeholder":{color:"#aab7c4"}},invalid:{color:"#fa755a",iconColor:"#fa755a"}}});t.mount("#card-element"),t.on("change",r=>{const o=document.getElementById("card-errors");r.error?o.textContent=r.error.message:o.textContent=""}),this.cardElement=t},async initiateTabbyPayment(){var e,t,r;this.loading=!0;try{if(!this.shippingDetails.addressId){this.$toast.error("The address id field is required.");return}const o=localStorage.getItem("auth_user");if(!o){this.$toast.error("User authentication required");return}const s=JSON.parse(o),i=s==null?void 0:s.id;if(!i){this.$toast.error("User authentication required");return}if(!Array.isArray(this.cartItems)||this.cartItems.length===0){this.$toast.error("No items in cart");return}const n=this.cartItems.reduce((m,b)=>m+b.price*b.quantity,0),l=this.cartItems.map(m=>{var b,A;return{product_id:(b=m.product)==null?void 0:b.id,product_name:((A=m.product)==null?void 0:A.name)||"",quantity:parseInt(m.quantity)||0,price:parseFloat(m.price)||0,subtotal:(parseFloat(m.price)||0)*(parseInt(m.quantity)||0)}}).filter(m=>m.product_id&&m.quantity>0),g=((e=this.user)==null?void 0:e.name)||(s==null?void 0:s.name)||"Guest",k=((t=this.user)==null?void 0:t.email)||(s==null?void 0:s.email)||"",I=((r=this.user)==null?void 0:r.phone)||(s==null?void 0:s.phone)||"",_={user_id:i,total_price:n,shipping_address:this.shippingDetails.address||"",address_id:this.shippingDetails.addressId,items:l,user:{name:g,email:k,phone:I}},L={Authorization:`Bearer ${localStorage.getItem("auth_token")}`},h=await v.post(`${f}/api/payment/tabby/send`,_,{headers:L});h.data.status==="success"&&(console.log("Redirecting to:",h.data.data.payment_url),window.location.href=h.data.data.payment_url)}catch(o){console.error("Tabby Payment Error:",o),this.$toast.error((o==null?void 0:o.message)||"Unexpected Tabby payment error")}finally{this.loading=!1}},async placeOrder(){var e,t,r,o,s,i,n,l,g,k,I,_,L;try{if(this.loading=!0,!this.shippingDetails.addressId){this.$toast.error("The address id field is required.");return}let h;try{const c=localStorage.getItem("auth_user");if(c){const p=JSON.parse(c);h=p==null?void 0:p.id}}catch(c){console.error("Error parsing auth_user:",c),this.$toast.error("Error getting user information");return}if(!h){this.$toast.error("User authentication required");return}if(!Array.isArray(this.cartItems)||this.cartItems.length===0){this.$toast.error("No items in cart");return}const m=this.cartItems.reduce((c,p)=>c+p.price*p.quantity,0),b={user_id:h,order:{status:"pending",payment_method:this.selectedPaymentMethod===1?"stripe":this.selectedPaymentMethod===2?"tabby":"cod",shipping_address:this.shippingDetails.address||"",address_id:this.shippingDetails.addressId,items:this.cartItems.map(c=>{var p,q;return{product_id:(p=c.product)==null?void 0:p.id,product_name:((q=c.product)==null?void 0:q.name)||"",quantity:parseInt(c.quantity)||0,price:parseFloat(c.price)||0,subtotal:(parseFloat(c.price)||0)*(parseInt(c.quantity)||0),created_at:new Date().toISOString(),updated_at:new Date().toISOString()}}).filter(c=>c.product_id&&c.quantity>0),total_price:m,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}};if(!b.order.items.length){this.$toast.error("Invalid order items");return}const A={Authorization:`Bearer ${localStorage.getItem("auth_token")}`};if(this.selectedPaymentMethod===1){const c=await v.post(`${f}/api/payment/process`,{...b,amount:m,currency:this.currency,payment_method:"stripe"},{headers:A});if((e=c==null?void 0:c.data)!=null&&e.success&&((t=c==null?void 0:c.data)!=null&&t.url)){window.location.href=c.data.url;return}else throw new Error(((r=c==null?void 0:c.data)==null?void 0:r.error)||((o=c==null?void 0:c.data)==null?void 0:o.message)||this.$t("checkout.errorCreatingPaymentSession"))}if(this.selectedPaymentMethod===2){const c=await v.post(`${f}/api/payment/process`,{user_id:h,payment_method:"tabby",order:{status:"pending",payment_method:"tabby",shipping_address:this.shippingDetails.address||"",address_id:this.shippingDetails.addressId,items:this.cartItems.map(p=>{var q,V;return{product_id:(q=p.product)==null?void 0:q.id,product_name:((V=p.product)==null?void 0:V.name)||"",quantity:parseInt(p.quantity)||0,price:parseFloat(p.price)||0,subtotal:(parseFloat(p.price)||0)*(parseInt(p.quantity)||0)}}).filter(p=>p.product_id&&p.quantity>0),total_price:m},user:{name:this.user.name,email:this.user.email,phone:this.user.phone}},{headers:A});if(((s=c==null?void 0:c.data)==null?void 0:s.status)==="success"&&((i=c.data.data)!=null&&i.payment_url)){this.$toast.success("Redirecting to Tabby..."),window.location.href=c.data.data.payment_url;return}else throw new Error(((n=c==null?void 0:c.data)==null?void 0:n.message)||((l=c==null?void 0:c.data)==null?void 0:l.error)||"Error creating Tabby session.")}if(this.selectedPaymentMethod===3){const c=await v.post(`${f}/api/orders`,b,{headers:A});if(((g=c==null?void 0:c.data)==null?void 0:g.status)==="success"){this.$toast.success(this.$t("checkout.orderPlacedSuccessfully")),window.location.href="/orders/user";return}else{const p=((k=c==null?void 0:c.data)==null?void 0:k.message)||((I=c==null?void 0:c.data)==null?void 0:I.error)||"Error placing order";throw new Error(p)}}}catch(h){console.error("Error placing order:",h);let m="Unexpected error while placing your order.";try{(_=h==null?void 0:h.response)!=null&&_.data?m=h.response.data.message||h.response.data.error||h.message||m:h!=null&&h.message&&(m=h.message)}catch(b){console.warn("Error extracting message:",b)}(L=this==null?void 0:this.$toast)!=null&&L.error?this.$toast.error(m):window.location.href="/orders/user"}finally{this.loading=!1}},async createOrder(){if(!this.shippingDetails.addressId){this.$toast.error("The address id field is required.");return}const e=this.cartItems.reduce((o,s)=>o+s.price*s.quantity,0),t=this.selectedPaymentMethod===3?"cod":String(this.selectedPaymentMethod),r={shipping_details:this.shippingDetails,address_id:this.shippingDetails.addressId,payment_method:t,items:this.cartItems.map(o=>({product_id:o.product.id,quantity:o.quantity,price:o.price,subtotal:o.price*o.quantity})),total_price:e};try{const o=await v.post(`${f}/api/orders`,r,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});if(o.data.success)console.log(o),window.location.href="/orders/user";else throw new Error(o.data.error||this.$t("checkout.errorPlacingOrder"))}catch(o){console.error(o),this.$t("checkout.errorPlacingOrder")}},getCountryCode(e){const t={"United States":"US","United Kingdom":"GB",Egypt:"EG","Saudi Arabia":"SA","United Arab Emirates":"AE",Kuwait:"KW",Qatar:"QA",Bahrain:"BH",Oman:"OM",Jordan:"JO",Lebanon:"LB",Iraq:"IQ",Syria:"SY",Yemen:"YE",Libya:"LY",Sudan:"SD",Morocco:"MA",Algeria:"DZ",Tunisia:"TN",Palestine:"PS",Israel:"IL",Turkey:"TR",Iran:"IR",Pakistan:"PK",India:"IN",China:"CN",Japan:"JP","South Korea":"KR",Singapore:"SG",Malaysia:"MY",Indonesia:"ID",Australia:"AU","New Zealand":"NZ",Canada:"CA",Mexico:"MX",Brazil:"BR",Argentina:"AR","South Africa":"ZA",Nigeria:"NG",Kenya:"KE",Ghana:"GH",Ethiopia:"ET",Tanzania:"TZ",Uganda:"UG",Rwanda:"RW",Senegal:"SN","Côte d'Ivoire":"CI",Cameroon:"CM",Angola:"AO",Mozambique:"MZ",Madagascar:"MG",Mauritius:"MU",Seychelles:"SC",Comoros:"KM",Djibouti:"DJ",Eritrea:"ER",Somalia:"SO","South Sudan":"SS",Chad:"TD",Niger:"NE",Mali:"ML","Burkina Faso":"BF",Benin:"BJ",Togo:"TG",Guinea:"GN","Guinea-Bissau":"GW","Sierra Leone":"SL",Liberia:"LR","Cape Verde":"CV","São Tomé and Príncipe":"ST","Equatorial Guinea":"GQ",Gabon:"GA","Republic of the Congo":"CG","Democratic Republic of the Congo":"CD","Central African Republic":"CF",Burundi:"BI",Zambia:"ZM",Zimbabwe:"ZW",Malawi:"MW",Namibia:"NA",Botswana:"BW",Lesotho:"LS",Eswatini:"SZ",Mauritania:"MR","Western Sahara":"EH","The Gambia":"GM","Guinea-Bissau":"GW","Sierra Leone":"SL",Liberia:"LR","Cape Verde":"CV","São Tomé and Príncipe":"ST","Equatorial Guinea":"GQ",Gabon:"GA","Republic of the Congo":"CG","Democratic Republic of the Congo":"CD","Central African Republic":"CF",Burundi:"BI",Zambia:"ZM",Zimbabwe:"ZW",Malawi:"MW",Namibia:"NA",Botswana:"BW",Lesotho:"LS",Eswatini:"SZ",Mauritania:"MR","Western Sahara":"EH","The Gambia":"GM"};if(/^[A-Z]{2}$/.test(e))return e;const r=t[e];return r||null}}},lt={class:"checkout-step"},ut={class:"payment-methods"},pt=["onClick"],ht={key:0,class:"stripe-container"},mt={class:"order-summary"},yt={class:"summary-details"},gt={class:"total-amount"},_t={class:"button-group"},vt=["disabled"],ft={key:0},bt={key:1};function St(e,t,r,o,s,i){const n=$("fa");return u(),y("div",lt,[a("h2",null,d(e.$t("checkout.payment")),1),a("div",ut,[(u(!0),y(N,null,G(s.paymentMethods,l=>(u(),y("div",{key:l.id,class:S(["payment-method",{active:s.selectedPaymentMethod===l.id}]),onClick:g=>i.selectPaymentMethod(l.id)},[U(n,{icon:l.icon},null,8,["icon"]),a("span",null,d(l.name),1)],10,pt))),128))]),s.selectedPaymentMethod===1?(u(),y("div",ht,t[2]||(t[2]=[a("div",{class:"card-element-container"},[a("div",{id:"card-element",class:"card-element"}),a("div",{id:"card-errors",class:"card-errors",role:"alert"})],-1)]))):C("",!0),a("div",mt,[a("h3",null,d(e.$t("checkout.orderSummary")),1),a("div",yt,[a("p",null,d(r.cartItems.length)+" "+d(e.$t("checkout.items")),1),a("p",null,d(e.$t("checkout.deliveryTo"))+": "+d(r.shippingDetails.city),1),a("p",null,d(e.$t("checkout.tax"))+": "+d(r.shippingDetails.tax)+" "+d(r.currency),1),a("p",null,d(e.$t("checkout.total"))+": "+d(r.shippingDetails.total)+" "+d(r.currency),1),a("div",gt,d(e.$t("checkout.totalAmount"))+": "+d(r.total)+" "+d(r.currency),1)])]),a("div",_t,[a("button",{class:"btn-secondary",onClick:t[0]||(t[0]=l=>e.$emit("previous-step"))},d(e.$t("checkout.back")),1),a("button",{class:"btn-primary",disabled:!s.selectedPaymentMethod||s.loading,onClick:t[1]||(t[1]=l=>s.selectedPaymentMethod===2?i.initiateTabbyPayment():i.placeOrder())},[s.loading?(u(),y("span",ft,d(e.$t("checkout.processing"))+"...",1)):(u(),y("span",bt,d(e.$t("checkout.placeOrder")),1))],8,vt)])])}const kt=M(ct,[["render",St],["__scopeId","data-v-f3cb1379"]]);const It={name:"Checkout",components:{Header:H,CheckoutStepper:re,CartReview:Se,ShippingDetails:He,PaymentStep:kt},data(){return{step:1,cartItems:[],shippingDetails:{fullName:"",address:"",city:"",postalCode:"",phone:"",buildingName:"",floorNumber:"",apartmentNumber:"",landmark:"",street:"",country:""}}},computed:{currentLang(){return localStorage.getItem("lang")||"en"},currency(){if(this.cartItems.length>0){if(this.cartItems[0].currency.code)return this.cartItems[0].currency.code.toLowerCase();const e=(this.currentLang==="ar"?this.cartItems[0].currency.name_ar:this.cartItems[0].currency.name_en).toLowerCase();return{"us dollar":"usd",usd:"usd","british pound":"gbp",gbp:"gbp",euro:"eur",eur:"eur","درهم إماراتي":"aed",aed:"aed","جنيه مصري":"egp",egp:"egp"}[e]||"usd"}return"usd"},total(){return(this.cartItems.reduce((t,r)=>t+parseFloat(r.price)*r.quantity,0)+this.shippingCost).toFixed(2)}},created(){this.fetchCartItems()},methods:{async fetchCartItems(){try{const e=JSON.parse(localStorage.getItem("selectedCurrency"))||{code:"USD"},t=await v.get(`${f}/api/cart-items`,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`,Currency:e.code}});this.cartItems=t.data.data.original.data}catch(e){console.error("Error fetching cart items:",e),this.$toast.error(this.$t("checkout.errorFetchingCart"))}},updateCart(){this.fetchCartItems()},nextStep(){this.step<3&&this.step++},previousStep(){this.step>1&&this.step--},async handleOrderPlaced(){const e={payment_method:this.cartItems[0].payment_method||"paypal",user_id:localStorage.getItem("user_id"),order:{status:"pending",payment_method:this.selectedPaymentMethod===1?"stripe":"cash",shipping_address:`${this.shippingDetails.street}, ${this.shippingDetails.city}, ${this.shippingDetails.country}`},items:this.cartItems.map(t=>({product_id:t.product_id,product_name:t.product_name,quantity:t.quantity,price:t.price}))};try{const t=await v.post(`${f}/api/orders`,e,{headers:{Authorization:`Bearer ${localStorage.getItem("auth_token")}`}});this.$router.push("/order-confirmation")}catch(t){console.error("Error placing order:",t),this.$toast.error(this.$t("checkout.errorPlacingOrder"))}}},mounted(){window.addEventListener("currency-changed",()=>{this.fetchCartItems()})}},wt={class:"checkout-container"};function Ct(e,t,r,o,s,i){const n=$("Header"),l=$("CheckoutStepper"),g=$("CartReview"),k=$("ShippingDetails"),I=$("PaymentStep");return u(),y(N,null,[U(n),a("div",wt,[U(l,{step:s.step},null,8,["step"]),s.step===1?(u(),O(g,{key:0,"cart-items":s.cartItems,"shipping-cost":e.shippingCost,currency:i.currency,onNextStep:i.nextStep,onUpdateCart:i.updateCart},null,8,["cart-items","shipping-cost","currency","onNextStep","onUpdateCart"])):C("",!0),s.step===2?(u(),O(k,{key:1,modelValue:s.shippingDetails,"onUpdate:modelValue":t[0]||(t[0]=_=>s.shippingDetails=_),onNextStep:i.nextStep,onPreviousStep:i.previousStep},null,8,["modelValue","onNextStep","onPreviousStep"])):C("",!0),s.step===3?(u(),O(I,{key:2,"cart-items":s.cartItems,"shipping-details":s.shippingDetails,total:i.total,currency:i.currency,onPreviousStep:i.previousStep,onOrderPlaced:i.handleOrderPlaced},null,8,["cart-items","shipping-details","total","currency","onPreviousStep","onOrderPlaced"])):C("",!0)])],64)}const At=M(It,[["render",Ct],["__scopeId","data-v-91c7d643"]]);export{At as default};
